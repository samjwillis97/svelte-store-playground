var ce=Object.defineProperty;var fe=(t,e,n)=>e in t?ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var D=(t,e,n)=>(fe(t,typeof e!="symbol"?e+"":e,n),n);import{J as se,S as de,i as he,s as _e,k as L,q as A,a as O,l as k,m as w,r as V,h as s,c as N,b as p,G as c,K as H,H as x,L as pe,I as ee,M as ge,u as me}from"../chunks/index.11bf829d.js";import{w as ae}from"../chunks/index.3f08586d.js";const be=5,Ee=500,F=new Map;function ve(t,e){const n=F.get(t);if(n)return z(t),n.store;console.log(`creating: ${t}`);const o=we(e);return F.set(t,o),j(o,e),F.get(t).store}function j(t,e,n=0){console.log("executing fn"),n<be&&e().then(o=>Te(t,o)).catch(()=>{t.store.update(o=>(o.isError=!0,o)),n=n+1,console.log(`retry: ${n}`),setTimeout(()=>{j(t,e,n)},n*Ee)})}function z(t){if(console.log(`refreshing: ${t}`),!F.has(t))return;const e=F.get(t);e.store.update(n=>(n.isLoading=!0,n)),j(e,e.function)}class Le{constructor(e,n,o){D(this,"key");D(this,"fn");D(this,"optimisticMutateFn");D(this,"isLoading",!1);D(this,"isError",!1);this.key=e,this.fn=n,this.optimisticMutateFn=o}mutate(){this.isLoading=!0,this.isError=!1,console.log(`mutating v2 ${this.key}`);const e=F.get(this.key),n=se(e.store).data,o=JSON.parse(JSON.stringify(n));if(this.optimisticMutateFn&&n){const i=this.optimisticMutateFn(n);e.store.update(a=>(a.data=i,a))}this.fn().then(()=>{e&&z(this.key),this.isLoading=!1}).catch(()=>{this.isError=!0,this.isLoading=!1,console.log(`error mutating: ${this.key}`),this.optimisticMutateFn&&e.store.update(i=>(i.data=o,i))}).finally(()=>{this.isLoading=!1})}}function ke(t,e,n){const o=new Le(t,e,n);return ae(o)}function W(t,e,n){console.log(`mutating ${t}`);const o=F.get(t),i=se(o.store).data,a=JSON.parse(JSON.stringify(i));if(n&&i){const r=n(i);o.store.update(d=>(d.data=r,d))}e().then(()=>{o&&z(t)}).catch(()=>{console.log(`error mutating: ${t}`),n&&o.store.update(r=>(r.data=a,r))})}function we(t){return{function:t,store:ae({isLoading:!0,isError:!1,data:void 0})}}function Te(t,e){return t.store.update(n=>(n.isLoading=!1,n.isError=!1,n.data=e,n)),t}async function K(t){return new Promise(e=>setTimeout(e,t*1e3))}let S=[];const Ae=.5,Q=.25;async function Ve(){if(await K(Q),R())throw new Error("unable to get");return console.log("service: get"),console.log(S),JSON.parse(JSON.stringify(S))}async function ue(){if(await K(Q),R())throw new Error("unable to add");return S.push(S.length.toString()),console.log("service: add"),console.log(S),!0}async function Ie(){if(await K(Q),R())throw new Error("unable to deleteAll");return S=[],console.log("service: deleteAll"),console.log(S),!0}async function Me(t){if(await K(Q),R())throw new Error("unable to deleteItem");const e=S.findIndex(n=>n===t);return e!==-1&&S.splice(e,1),console.log("service: deleteOne"),console.log(S),!0}function R(){return Math.random()<Ae}function Oe(){return ve("todos",Ve)}function Ne(){return ke("todos",ue,t=>{if(t)return t.push(t==null?void 0:t.length.toString()),t})}function Se(){W("todos",ue,t=>{if(t)return t.push(t==null?void 0:t.length.toString()),t})}function ye(t){W("todos",async()=>await Me(t))}function Je(){W("todos",Ie)}function te(t,e,n){const o=t.slice();return o[7]=e[n],o}function oe(t){let e,n;return{c(){e=L("p"),n=A("Adder Loading")},l(o){e=k(o,"P",{});var i=w(e);n=V(i,"Adder Loading"),i.forEach(s)},m(o,i){p(o,e,i),c(e,n)},d(o){o&&s(e)}}}function ne(t){let e,n;return{c(){e=L("p"),n=A("Error Adding")},l(o){e=k(o,"P",{});var i=w(e);n=V(i,"Error Adding"),i.forEach(s)},m(o,i){p(o,e,i),c(e,n)},d(o){o&&s(e)}}}function Pe(t){let e,n;return{c(){e=L("p"),n=A("Finished")},l(o){e=k(o,"P",{});var i=w(e);n=V(i,"Finished"),i.forEach(s)},m(o,i){p(o,e,i),c(e,n)},d(o){o&&s(e)}}}function $e(t){let e,n;return{c(){e=L("p"),n=A("Loading")},l(o){e=k(o,"P",{});var i=w(e);n=V(i,"Loading"),i.forEach(s)},m(o,i){p(o,e,i),c(e,n)},d(o){o&&s(e)}}}function ie(t){let e,n;return{c(){e=L("p"),n=A("Error Loading")},l(o){e=k(o,"P",{});var i=w(e);n=V(i,"Error Loading"),i.forEach(s)},m(o,i){p(o,e,i),c(e,n)},d(o){o&&s(e)}}}function le(t){let e,n=t[1].data,o=[];for(let i=0;i<n.length;i+=1)o[i]=re(te(t,n,i));return{c(){e=L("ul");for(let i=0;i<o.length;i+=1)o[i].c()},l(i){e=k(i,"UL",{});var a=w(e);for(let r=0;r<o.length;r+=1)o[r].l(a);a.forEach(s)},m(i,a){p(i,e,a);for(let r=0;r<o.length;r+=1)o[r]&&o[r].m(e,null)},p(i,a){if(a&2){n=i[1].data;let r;for(r=0;r<n.length;r+=1){const d=te(i,n,r);o[r]?o[r].p(d,a):(o[r]=re(d),o[r].c(),o[r].m(e,null))}for(;r<o.length;r+=1)o[r].d(1);o.length=n.length}},d(i){i&&s(e),ge(o,i)}}}function re(t){let e,n,o=t[7]+"",i,a,r,d,I,g,m,J,u,$;function U(){return t[6](t[7])}return{c(){e=L("div"),n=L("li"),i=A(o),a=O(),r=L("button"),d=A("info"),I=O(),g=L("button"),m=A("delete"),J=O()},l(T){e=k(T,"DIV",{});var h=w(e);n=k(h,"LI",{});var M=w(n);i=V(M,o),M.forEach(s),a=N(h),r=k(h,"BUTTON",{});var B=w(r);d=V(B,"info"),B.forEach(s),I=N(h),g=k(h,"BUTTON",{});var q=w(g);m=V(q,"delete"),q.forEach(s),J=N(h),h.forEach(s)},m(T,h){p(T,e,h),c(e,n),c(n,i),c(e,a),c(e,r),c(r,d),c(e,I),c(e,g),c(g,m),c(e,J),u||($=H(g,"click",U),u=!0)},p(T,h){t=T,h&2&&o!==(o=t[7]+"")&&me(i,o)},d(T){T&&s(e),u=!1,$()}}}function Fe(t){let e,n,o,i,a,r,d,I,g,m,J,u,$,U,T,h,M,B,q,b=t[0].isError&&oe(),E=t[0].isError&&ne();function X(l,f){return l[1].isLoading?$e:Pe}let G=X(t),y=G(t),v=t[1].isError&&ie(),_=t[1].data&&t[1].data.length>0&&le(t);return{c(){e=L("button"),n=A("Add Item"),i=O(),a=L("button"),r=A("Add Item 2"),I=O(),g=L("button"),m=A("Clear All"),J=O(),u=L("div"),b&&b.c(),$=O(),E&&E.c(),U=O(),y.c(),T=O(),v&&v.c(),h=O(),M=L("div"),_&&_.c(),this.h()},l(l){e=k(l,"BUTTON",{});var f=w(e);n=V(f,"Add Item"),f.forEach(s),i=N(l),a=k(l,"BUTTON",{});var Y=w(a);r=V(Y,"Add Item 2"),Y.forEach(s),I=N(l),g=k(l,"BUTTON",{});var Z=w(g);m=V(Z,"Clear All"),Z.forEach(s),J=N(l),u=k(l,"DIV",{});var P=w(u);b&&b.l(P),$=N(P),E&&E.l(P),U=N(P),y.l(P),T=N(P),v&&v.l(P),P.forEach(s),h=N(l),M=k(l,"DIV",{});var C=w(M);_&&_.l(C),C.forEach(s),this.h()},h(){e.disabled=o=t[1].isLoading,a.disabled=d=t[0].isLoading},m(l,f){p(l,e,f),c(e,n),p(l,i,f),p(l,a,f),c(a,r),p(l,I,f),p(l,g,f),c(g,m),p(l,J,f),p(l,u,f),b&&b.m(u,null),c(u,$),E&&E.m(u,null),c(u,U),y.m(u,null),c(u,T),v&&v.m(u,null),p(l,h,f),p(l,M,f),_&&_.m(M,null),B||(q=[H(e,"click",t[4]),H(a,"click",t[5]),H(g,"click",Je)],B=!0)},p(l,[f]){f&2&&o!==(o=l[1].isLoading)&&(e.disabled=o),f&1&&d!==(d=l[0].isLoading)&&(a.disabled=d),l[0].isError?b||(b=oe(),b.c(),b.m(u,$)):b&&(b.d(1),b=null),l[0].isError?E||(E=ne(),E.c(),E.m(u,U)):E&&(E.d(1),E=null),G!==(G=X(l))&&(y.d(1),y=G(l),y&&(y.c(),y.m(u,T))),l[1].isError?v||(v=ie(),v.c(),v.m(u,null)):v&&(v.d(1),v=null),l[1].data&&l[1].data.length>0?_?_.p(l,f):(_=le(l),_.c(),_.m(M,null)):_&&(_.d(1),_=null)},i:x,o:x,d(l){l&&s(e),l&&s(i),l&&s(a),l&&s(I),l&&s(g),l&&s(J),l&&s(u),b&&b.d(),E&&E.d(),y.d(),v&&v.d(),l&&s(h),l&&s(M),_&&_.d(),B=!1,pe(q)}}}function Ue(t,e,n){let o,i,a=Oe();ee(t,a,m=>n(1,i=m));let r=Ne();ee(t,r,m=>n(0,o=m));function d(){console.log("adding"),Se()}function I(){o.mutate()}return r.subscribe(m=>console.log(m)),[o,i,a,r,d,I,m=>ye(m)]}class Ge extends de{constructor(e){super(),he(this,e,Ue,Fe,_e,{})}}export{Ge as component};
